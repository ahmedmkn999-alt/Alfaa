<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>المحاضرات | ALPHA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="auth.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { background: #000; color: white; font-family: 'Tajawal', sans-serif; min-height: 100vh; padding-bottom: 50px; }
        .bg-glow { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: radial-gradient(circle at 50% 10%, #1e1b4b, #000 70%); }
        .lecture-card { background: rgba(30, 41, 59, 0.6); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 24px; padding: 20px; margin-bottom: 24px; transition: 0.3s; }
        .lecture-card:hover { transform: translateY(-5px); border-color: #6366f1; }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
        .lec-label { color: #f472b6; font-size: 0.8rem; font-weight: bold; }
        .lec-title { font-size: 1.4rem; font-weight: 800; color: white; }
        .lec-img-box { width: 80px; height: 80px; border-radius: 16px; background: linear-gradient(135deg, #6366f1, #d946ef); padding: 2px; }
        .lec-img { width: 100%; height: 100%; border-radius: 14px; object-fit: cover; background: #1e293b; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .stat-box { background: rgba(0, 0, 0, 0.3); border-radius: 12px; padding: 10px 5px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.05); }
        .stat-icon { font-size: 1.2rem; color: #818cf8; }
        .btn-content { background: #0f172a; color: white; width: 100%; padding: 15px; border-radius: 16px; font-weight: bold; display: flex; justify-content: center; align-items: center; gap: 10px; border: 1px solid rgba(255,255,255,0.1); }
    </style>
</head>
<body>
    <div class="bg-glow"></div>
    <div id="app" class="p-5">
        <div class="flex items-center gap-4 mb-8">
            <button onclick="history.back()" class="w-10 h-10 bg-white/10 rounded-full text-white flex items-center justify-center">➜</button>
            <h1 class="text-2xl font-bold">{{ teacherName }}</h1>
        </div>

        <div v-if="loading" class="text-center mt-20">جاري التحميل...</div>

        <div v-else>
            <div v-for="(ch, index) in allLectures" :key="index" class="lecture-card">
                <div class="card-header">
                    <div>
                        <span class="lec-label">المحاضرة {{ index + 1 }}</span>
                        <h2 class="lec-title">{{ ch.chapter_name || ch.name }}</h2>
                    </div>
                    <div class="lec-img-box">
                        <img src="https://cdn-icons-png.flaticon.com/512/3413/3413535.png" class="lec-img">
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-box">
                        <i class="fas fa-video stat-icon"></i>
                        <div class="font-bold">{{ getVideos(ch).length }}</div>
                        <div class="text-xs text-gray-400">فيديو</div>
                    </div>
                    <div class="stat-box">
                        <i class="fas fa-file-alt stat-icon"></i>
                        <div class="font-bold">0</div>
                        <div class="text-xs text-gray-400">ملف</div>
                    </div>
                    <div class="stat-box">
                        <i class="fas fa-pen-fancy stat-icon"></i>
                        <div class="font-bold">0</div>
                        <div class="text-xs text-gray-400">امتحان</div>
                    </div>
                </div>

                <button @click="openLecture(ch)" class="btn-content">
                    محتوى المحاضرة <i class="fas fa-arrow-left"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted } = Vue;
        createApp({
            setup() {
                const allLectures = ref([]);
                const loading = ref(true);
                const teacherName = ref('');
                const params = new URLSearchParams(window.location.search);

                const getVideos = (ch) => {
                    let vids = [];
                    if(ch.videos) vids = [...ch.videos];
                    if(ch.lectures) ch.lectures.forEach(l => { if(l.videos) vids = [...vids, ...l.videos] });
                    return vids;
                };

                const openLecture = (ch) => {
                    localStorage.setItem('selectedLectureVids', JSON.stringify(getVideos(ch)));
                    localStorage.setItem('selectedLectureTitle', ch.chapter_name || ch.name);
                    window.location.href = 'parts.html';
                };

                onMounted(async () => {
                    const code = checkAuth();
                    const db = firebase.database();
                    const snap = await db.ref('approvedStudents/'+code).once('value');
                    const section = snap.val().section;
                    const res = await fetch("https://plus-teal.vercel.app/organized_output.json");
                    const data = await res.json();
                    
                    const year = data.find(y => y.id == params.get('yid')) || data[0];
                    const sub = year.subjects.find(s => s.id == params.get('sid'));
                    const teacher = sub.teachers.find(t => t.id == params.get('tid'));
                    
                    teacherName.value = teacher.name;
                    
                    // استخراج كافة الفصول/المحاضرات بشكل مسطح لعرضها في كروت منفصلة
                    let tempLectures = [];
                    if(teacher.units) {
                        teacher.units.forEach(u => { if(u.chapters) tempLectures.push(...u.chapters); });
                    } else if(teacher.chapters) {
                        tempLectures = teacher.chapters;
                    }
                    allLectures.value = tempLectures;
                    loading.value = false;
                });
                return { allLectures, loading, teacherName, getVideos, openLecture };
            }
        }).mount('#app');
    </script>
</body>
    </html>
    
